Commits in this patch:
----------------------

  3e2e3dee94d3cf1083aec4772a612bc119308543
  mm: rmap: explicitly reset vma->anon_vma in unlink_anon_vmas()



mm: rmap: explicitly reset vma->anon_vma in unlink_anon_vmas()

jira LE-894
cve CVE-2024-42703
commit ee8ab1903e3d912d8f10bedbf96c3b6a1c8cbede

In case the vma will continue to be used after unlink its relevant
anon_vma, we need to reset the vma->anon_vma pointer to NULL.  So, later
when fault happen within this vma again, a new anon_vma will be prepared.

By this way, the vma will only be checked for reverse mapping of pages
which been fault in after the unlink_anon_vmas call.

Currently, the mremap with MREMAP_DONTUNMAP scenario will continue use the
vma after moved its page table entries to a new vma.  For other scenarios,
the vma itself will be freed after call unlink_anon_vmas.

Link: https://lkml.kernel.org/r/20210119075126.3513154-1-lixinhai.lxh@gmail.com
	Signed-off-by: Li Xinhai <lixinhai.lxh@gmail.com>
	Cc: Andrea Arcangeli <aarcange@redhat.com>
	Cc: Brian Geffon <bgeffon@google.com>
	Cc: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>
	Cc: Lokesh Gidra <lokeshgidra@google.com>
	Cc: Minchan Kim <minchan@kernel.org>
	Cc: Vlastimil Babka <vbabka@suse.cz>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit ee8ab1903e3d912d8f10bedbf96c3b6a1c8cbede)
Signed-off-by: Jonathan Maple <jmaple@ciq.com>
diff --git a/mm/rmap.c b/mm/rmap.c
index 7c0a3c4f1625..b26133610318 100644
--- a/mm/rmap.c
+++ b/mm/rmap.c
@@ -412,8 +412,15 @@ void unlink_anon_vmas(struct vm_area_struct *vma)
 		list_del(&avc->same_vma);
 		anon_vma_chain_free(avc);
 	}
-	if (vma->anon_vma)
+	if (vma->anon_vma) {
 		vma->anon_vma->degree--;
+
+		/*
+		 * vma would still be needed after unlink, and anon_vma will be prepared
+		 * when handle fault.
+		 */
+		vma->anon_vma = NULL;
+	}
 	unlock_anon_vma_root(root);
 
 	/*
-- 
2.39.3

