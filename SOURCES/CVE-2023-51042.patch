Commits in this patch:
----------------------

  554432d8745162820e1e7e8ad769741befe5d7d5
  drm/amdgpu: Fix potential fence use-after-free v2



drm/amdgpu: Fix potential fence use-after-free v2

jira SECO-48
cve CVE-2023-51042
commit 2e54154b9f27262efd0cb4f903cc7d5ad1fe9628

fence Decrements the reference count before exiting.
Avoid Race Vulnerabilities for fence use-after-free.

v2 (chk): actually fix the use after free and not just move it.

    Signed-off-by: shanzhulig <shanzhulig@gmail.com>
    Signed-off-by: Christian KÃ¶nig <christian.koenig@amd.com>
    Reviewed-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    (cherry picked from commit 2e54154b9f27262efd0cb4f903cc7d5ad1fe9628)
Signed-off-by: Ronnie Sahlberg <rsahlberg@ciq.com>
diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_cs.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_cs.c
index 30fa1f61e0e5..6beebf53fa65 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_cs.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_cs.c
@@ -1500,15 +1500,15 @@ static int amdgpu_cs_wait_all_fences(struct amdgpu_device *adev,
 			continue;
 
 		r = dma_fence_wait_timeout(fence, true, timeout);
+		if (r > 0 && fence->error)
+			r = fence->error;
+
 		dma_fence_put(fence);
 		if (r < 0)
 			return r;
 
 		if (r == 0)
 			break;
-
-		if (fence->error)
-			return fence->error;
 	}
 
 	memset(wait, 0, sizeof(*wait));
-- 
2.39.3

