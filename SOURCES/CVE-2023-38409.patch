Commits in this patch:
----------------------

  a5fa32a3d7d0cc991c965f41f0dd588ccd6b0481
  fbcon: set_con2fb_map needs to set con2fb_map!



fbcon: set_con2fb_map needs to set con2fb_map!

jira LE-886
cve CVE-2023-38409
commit fffb0b52d5258554c645c966c6cbef7de50b851d
upstream-diff Upstream has d443d9386472 which allows the con2fb_map[unit]
position swap to apply cleanly.

I got really badly confused in d443d9386472 ("fbcon: move more common
code into fb_open()") because we set the con2fb_map before the failure
points, which didn't look good.

But in trying to fix that I moved the assignment into the wrong path -
we need to do it for _all_ vc we take over, not just the first one
(which additionally requires the call to con2fb_acquire_newinfo).

I've figured this out because of a KASAN bug report, where the
fbcon_registered_fb and fbcon_display arrays went out of sync in
fbcon_mode_deleted() because the con2fb_map pointed at the old
fb_info, but the modes and everything was updated for the new one.

    Signed-off-by: Daniel Vetter <daniel.vetter@intel.com>
    Reviewed-by: Javier Martinez Canillas <javierm@redhat.com>
    Acked-by: Helge Deller <deller@gmx.de>
    Tested-by: Xingyuan Mo <hdthky0@gmail.com>
    Fixes: d443d9386472 ("fbcon: move more common code into fb_open()")
    Reported-by: Xingyuan Mo <hdthky0@gmail.com>
    Cc: Thomas Zimmermann <tzimmermann@suse.de>
    Cc: Sam Ravnborg <sam@ravnborg.org>
    Cc: Xingyuan Mo <hdthky0@gmail.com>
    Cc: Thomas Zimmermann <tzimmermann@suse.de>
    Cc: Helge Deller <deller@gmx.de>
    Cc: <stable@vger.kernel.org> # v5.19+
    (cherry picked from commit fffb0b52d5258554c645c966c6cbef7de50b851d)

Signed-off-by: David Gomez <dgomez@ciq.com>
diff --git a/drivers/video/fbdev/core/fbcon.c b/drivers/video/fbdev/core/fbcon.c
index dd965f7c6ff4..90852ad782ab 100644
--- a/drivers/video/fbdev/core/fbcon.c
+++ b/drivers/video/fbdev/core/fbcon.c
@@ -859,10 +859,10 @@ static int set_con2fb_map(int unit, int newidx, int user)
 
 	found = search_fb_in_map(newidx);
 
-	con2fb_map[unit] = newidx;
 	if (!err && !found)
  		err = con2fb_acquire_newinfo(vc, info, unit, oldidx);
 
+	con2fb_map[unit] = newidx;
 
 	/*
 	 * If old fb is not mapped to any of the consoles,
-- 
2.39.3

